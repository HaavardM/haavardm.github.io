(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-3763bfc4"],{"07aa":function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"container-fluid"},[a("AnyoneThere"),e._m(0)],1)},n=[function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"container"},[a("div",{staticClass:"card m-2 p-4 text-left"},[a("h1",{staticClass:"text-center"},[e._v("What is this?")]),a("p",[e._v(" What your're looking at is a small embedded / cloud project I did for fun. The emoji indicates whether there is movement in front of the computer, i.e. if I am present in the room or not. The purpose of this project was mainly to play around with embedded electronics and cloud software. ")]),a("label",[e._v("The project consist of three parts:")]),a("ol",[a("li",[e._v("An embedded Particle Core microcontroller with WiFi support.")]),a("li",[e._v(" A backend for IoT event handling, using Google Cloud IoT Hub, Pub/Sub, Rust and GKE ")]),a("li",[e._v("The frontend webapplication you are looking at.")])]),a("hr"),a("h2",[e._v("Part 1: Embedded")]),a("span",[e._v(" The embedded part of the project is based on a Particle Core Dev Kit. The microcontroller is using a cheap PIR sensor to detect movement. When the state changes, the microcontroller sends a message using MQTT with TLS to Google Cloud IoT Hub (more on this later). In order to perform authentication with IoT Hub, a valid JWT needs to be signed by the device and used as password when connecting to the MQTT broker. As no JWT library was found among the public libraries for the Particle Core, the JWT was manually created and then signed using the opensource library mbedtls. The ES256 signature was generated using a sha256 hash and ECDSA with the secp256r1 (P-265) curve. Generating a valid JWT turned out to be more challenging than expected. Even after I was able to confirm the signature using OpenSSL, the JWT was still not accepted. In the end it turned out that the function "),a("code",[e._v("mbedtls_ecdsa_write_signature")]),e._v(" automatically removes any leading zeros from the signature (which is common practice in many usecases), while JWT expects leading zeros to be included. Manually creating the ECDSA signature "),a("code",[e._v("r")]),e._v(" and "),a("code",[e._v("s")]),e._v(" solved the issue. The microcontroller is now able to automatically generate a valid JWT from a private key, detect movement in the apartment and send messages using MQTT. ")]),a("hr"),a("h2",[e._v("Part 2: The Cloud")]),a("span",[e._v(" Google Cloud IoT Hub receives messages from the MQTT broker and automatically publish the messages on a predefined Pub/Sub topic. In order to display the state on this page, a Rust application was developed to consume messages from a Pub/Sub subscription, aggregate the values and respond to HTTP request with the current state. This was my second time working with Rust and first time using Rust in an application for use in Linux / K8S. A few problems turned out to be annoying: "),a("ul",[a("li",[e._v(" Dependencies were a bit challenging. Several libraries imported "),a("code",[e._v("tokio")]),e._v(", but using different versions. This resulted in tokio complaining about multiple runtimes used in the same application. In the end I had to downgrade one of the libraries in order to avoid conflicts, forcing me to use an older release of tokio. ")]),a("li",[e._v(" When deploying Go applications, I usually like to use alpine Docker images to reduce the image size. This appeared to work for Rust as well according to the docs, but I was unable to get it to build. Rust was not able to compile the application due to some missing libraries and even after installing "),a("code",[e._v("libc6-compat")]),e._v(" it was still not working. I had to give up alpine for now, and reverted back to using a debian base image. ")]),a("li",[e._v(" The Rust development experience is still not as good as I would've hoped. The VSCode plugin was not able to provide any autocomplete most of the time, even if it was seemingly able to correctly infer return types. I might be spoiled coming from Golang as my daily driver, but I expect basic autocompletion when working with such a strongly typed language. ")]),a("li",[e._v(" The build times are slow. This is annoying, but I guess it is worth as you get zero-cost abstractions. Comparing the compile times to a language such as Golang would not be fair. ")])])]),a("span",[e._v(" Rust looks very promising, but to me it still feels immature. Most libraries are not yet considered stable, many libraries requires the nightly compiler, and the development tools (looking at you Rust VSCode plugin) still feels flaky. The generated Rust code is probably amazing, but I would still feel uncomfortable trusting the language for use in production systems. ")]),a("span",[e._v(" No persistent storage was used when implementing this application and the state will be lost if the K8S pod restarts. In the future I might (probably not) add Redis support or use a Google Cloud service such as Datastore. ")]),a("hr"),a("h2",[e._v("Part 3: The UI")]),e._v(" The UI is simply an extension to this website, a place where I can put all my small projects which do not need an entire setup. This application was built as a custom component in Vue, and simply polls the Rust API frequenctly to retrieve the latest status. Some UI magic later, and you can see the results here. ")])])}],s=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"container"},[a("transition",{attrs:{name:"fade",mode:"out-in"}},[a("div",{staticClass:"card m-2",class:e.getStateClass(e.state.current.value)},[a("div",{staticClass:"row m-5 p-2"},[a("div",{staticClass:"col state-text"},[e.state?a("h1",[e._v(e._s(e.prettyPrintState(e.state.current.value)))]):e._e()])])])]),a("div",{staticClass:"card m-2 py-4"},e._l(e.history,(function(t){return a("div",{key:t.timestamp,staticClass:"row m-2"},[a("hr"),a("div",{staticClass:"col state-text"},[a("p",[e._v(" "+e._s(e.prettyPrintState(t.value))+" ")])]),a("div",{staticClass:"col state-timestamp"},[a("p",[e._v(e._s(e.prettyPrintDate(t.timestamp)))])]),a("hr")])})),0)],1)},o=[],r=a("d4ec"),l=a("bee2"),u=a("262e"),c=a("2caf"),d=a("9ab4"),h=a("1b40"),p=a("bc3a"),m=a.n(p),v=function(e){Object(u["a"])(a,e);var t=Object(c["a"])(a);function a(){var e;return Object(r["a"])(this,a),e=t.apply(this,arguments),e.state={current:{value:"UNKNOWN",timestamp:""},history:[]},e}return Object(l["a"])(a,[{key:"update",value:function(){var e=this;m.a.get("https://anyonethere.shapingideas.fyi").then((function(t){e.state=t.data}))}},{key:"created",value:function(){this.update(),this.interval=setInterval(this.update,500)}},{key:"destroyed",value:function(){clearInterval(this.interval)}},{key:"getStateClass",value:function(e){switch(e){case"PRESENT":return"state-present";case"NOT_PRESENT":return"state-not-present";default:return""}}},{key:"prettyPrintState",value:function(e){switch(e){case"PRESENT":return"ðŸ™‰";case"NOT_PRESENT":return"ðŸ™ˆ";default:return"ðŸ™Š"}}},{key:"prettyPrintDate",value:function(e){return new Intl.DateTimeFormat("no",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}).format(Date.parse(e))}},{key:"history",get:function(){return this.state.history.reverse()}}]),a}(h["c"]);v=Object(d["a"])([h["a"]],v);var g=v,b=g,f=(a("2a68"),a("2877")),y=Object(f["a"])(b,s,o,!1,null,"b47f827c",null),w=y.exports,T={name:"AnyoneThereView",components:{AnyoneThere:w}},_=T,I=(a("b241"),Object(f["a"])(_,i,n,!1,null,"35a1e788",null));t["default"]=I.exports},"2a68":function(e,t,a){"use strict";a("e3b1")},a65b:function(e,t,a){},b241:function(e,t,a){"use strict";a("a65b")},e3b1:function(e,t,a){}}]);
//# sourceMappingURL=chunk-3763bfc4.3409c919.js.map